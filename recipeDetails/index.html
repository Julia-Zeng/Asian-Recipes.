<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Chinese Dumplings Recipe</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ytbfokayjuwdovzygubt.supabase.co/';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0YmZva2F5anV3ZG92enlndWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NTMyNDAsImV4cCI6MjA3NjAyOTI0MH0.lZv12D29lHDWYvmmolZbGBjuB6JMwdZB1SVIE52YmVg';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
</head>

<body id="my-body">
    <div id="title-container">
        <a href="../HomePage/index.html" id="home-button"><img class="home-button" src="../Images/home.png" alt=""></a>
        <h1 id="recipe-title"></h1>
        <div id="user-buttons"></div>
    </div>


    <div id="title" class="title">
    </div>
    <hr id="divider">
    <div id="subtitle" class="difficulty">
        <h3>Difficulty level: Easy | Total Time: 15 min |</h3>
    </div>

    <div id="recipe-image" class="dumplings-container1">
        <img src="../Images/Dumplings.JPG" alt="Chinese Dumplings image">
    </div>

    <div id="ingredients" class="ingredients">
        <h2>Ingredients:</h2>
    </div>

    <div id="steps" class="steps">
        <h2>Step-by-step Instructions</h2>
    </div>

    <div class="comment-section">
        <div class="add-comment">
            <h3>Rate this Recipe</h3>
            <input type="hidden" id="recipe-rate" value="0">
            <div id="stars"></div>
            <textarea id="comment-box"></textarea>
            <button type="submit" id="submit-comment" onclick="createNewComment()">POST</button>
        </div>
        <div class="comments-display">
            <h3>Comments</h3>
            <div id="comments-container"></div>
        </div>

</body>
<script>
    async function getRecipe() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        const recipe = await db
            .from('Recipes')
            .select('*')
            .eq('id', recipeId);
        if (recipe.error) {
            console.error(recipe.error);
        } else {
            document.getElementById('recipe-title').innerText = `${recipe.data[0].title}`;
            document.getElementById('subtitle').innerHTML = `<h3> Difficulty level: ${recipe.data[0].difficulty} | Total Time: ${recipe.data[0].time}</h3> <div id="average-rating"></div>`;
            document.getElementById('recipe-image').innerHTML = `<img src="${recipe.data[0].image}" alt="${recipe.data[0].title} image">`;
            for (const ingredient of recipe.data[0].ingredients) {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox">
                    <span>${ingredient}</span>
                `;
                document.getElementById('ingredients').appendChild(label);
            }
            let stepNumber = 1;
            for (const steps of recipe.data[0].steps) {
                const label = document.createElement('label');
                label.innerHTML = `
                    <div class="step-number">${stepNumber++}</div>
                    <p>${steps}</p>
                    <br>
                `;
                document.getElementById('steps').appendChild(label);
            }
            // <button id="favorite-button" onclick="toggleFavorite()">â™¡</button>
        }
        console.log('Checking favorite status for recipe ID:', recipeId);
        const favResult = await db.
            from('Favorites')
            .select('*')
            .eq('recipe_id', recipeId)
            .eq('user_id', localStorage.getItem("user_id"));
        if (favResult.error) {
            console.error(favResult.error);
        } else {
            console.log('Favorite check:', favResult.data);
            const favButton = document.createElement('img');
            favButton.id = 'favorite-button';
            favButton.className = 'user-buttons';
            favButton.onclick = toggleFavorite;
            if (favResult.data.length > 0) {
                favButton.src = '../Images/fullHeart.png';
            } else {
                favButton.src = '../Images/heart.png';
            }
            document.getElementById('user-buttons').appendChild(favButton);
        }
        if (localStorage.getItem("user_id") == recipe.data[0].owner) {
            document.getElementById("home-button").style.paddingRight = "72px";
            const editButton = document.createElement('img');
            editButton.id = 'edit-button';
            editButton.className = 'user-buttons';
            editButton.src = '../Images/lapiz.png';
            editButton.onclick = goToEditPage;
            document.getElementById('user-buttons').appendChild(editButton);

            const deleteButton = document.createElement('img');
            deleteButton.id = 'delete-button';
            deleteButton.className = 'user-buttons';
            deleteButton.onclick = deleteRecipe;
            deleteButton.src = '../Images/bin.png';
            document.getElementById('user-buttons').appendChild(deleteButton);
        }
    }
    getRecipe();
    async function createNewComment() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        const userId = localStorage.getItem("user_id");
        const commentText = document.getElementById('comment-box').value;
        const { data, error } = await db
            .from('comments')
            .insert([
                { recipe_id: recipeId, user_id: userId, comment: commentText, rate: document.getElementById('recipe-rate').value }
            ]);
        if (error) {
            console.error('Error adding comment:', error);
        } else {
            console.log('Comment added successfully:', data);
            alert('Comment added successfully!');
            await loadComments();
        }
    }
    async function loadComments() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        const { data, error } = await db
            .from('comments')
            .select('comment, Users ( email ), rate')
            .eq('recipe_id', recipeId);
        if (error) {
            console.error('Error fetching comments:', error);
        } else {
            const commentsContainer = document.getElementById('comments-container');
            commentsContainer.innerHTML = '';
            let average = 0;
            data.forEach(comment => {
                average += comment.rate;
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.innerHTML = `
                    <h4>${comment.Users.email} - Rating: ${getStarRatingHTMLComment(comment.rate)}</h4>
                    <p>${comment.comment}</p>
                `;
                commentsContainer.appendChild(commentDiv);
            });
            average = data.length ? (average / data.length) : 0;
            document.getElementById('average-rating').innerHTML = getStarRatingHTMLComment(average);
        }
    }
    loadComments();

    async function toggleFavorite() {
        const favButton = document.getElementById('favorite-button');
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        const userId = localStorage.getItem("user_id");
        if (favButton.src.includes('heart.png')) {
            const { data, error } = await db
                .from('Favorites')
                .insert([
                    { recipe_id: recipeId, user_id: userId }
                ]);
            if (error) {
                console.error('Error adding favorite:', error);
            } else {
                console.log('Favorite added successfully:', data);
                favButton.src = '../Images/fullHeart.png';
                alert('Favorite added successfully!');
            }
        } else {
            const { data, error } = await db
                .from('Favorites')
                .delete()
                .eq('recipe_id', recipeId)
                .eq('user_id', userId);
            if (error) {
                console.error('Error deleting favorite:', error);
            } else {
                console.log('Favorite deleted successfully:', data);
                favButton.src = '../Images/heart.png';
                alert('Favorite deleted successfully!');
            }
        }
    }

    async function deleteRecipe() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        const { data, error } = await db
            .from('Recipes')
            .delete()
            .eq('id', recipeId);
        if (error) {
            console.error('Error deleting recipe:', error);
        } else {
            console.log('Recipe deleted successfully:', data);
            alert('Recipe deleted successfully!');
            window.location.href = '../HomePage/index.html';
        }
    }
    function goToEditPage() {
        const urlParams = new URLSearchParams(window.location.search);
        const recipeId = urlParams.get('id');
        window.location.href = `../Pages/editRecipe.html?id=${recipeId}`;
    }
    document.getElementById('stars').innerHTML = getStarRatingHTML(0);
    function getStarRatingHTML(rating) {
        let stars = [];
        for (let i = 1; i <= 5; i++) {
            const src = i <= rating ? '../Images/fullStar.png' : '../Images/emptyStar.png';
            stars.push(`<img src="${src}" class="star" onclick="updateStarRating(${i})" alt="star" />`);
        }
        return stars.join('');
    }
    function getStarRatingHTMLComment(rating) {
        let stars = [];
        for (let i = 1; i <= 5; i++) {
            const src = i <= rating ? '../Images/fullStar.png' : '../Images/emptyStar.png';
            stars.push(`<img src="${src}" class="star" alt="star" />`);
        }
        return stars.join('');
    }
    function updateStarRating(rating) {
        document.getElementById('recipe-rate').value = rating;
        document.getElementById('stars').innerHTML = getStarRatingHTML(rating);
    }
</script>

</html>